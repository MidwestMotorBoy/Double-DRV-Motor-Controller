/*
 * FOC.c
 *
 *  Created on: Oct 1, 2019
 *      Author: LoganRosenmayer
 */
#include "FOC.h"


static float pc_coff = 816;//0.8164965f; fix pt x1000
//static float pc_coff = 0.66666666f;
static float data2angle = 0.3515625f;
// LUT is 1000x for fix pt
static int sin_lut_table[1024] = {0.000000,6.000000,12.000000,18.000000,25.000000,31.000000,37.000000,43.000000,49.000000,55.000000,61.000000,67.000000,74.000000,80.000000,86.000000,92.000000,98.000000,104.000000,110.000000,116.000000,122.000000,128.000000,135.000000,141.000000,147.000000,153.000000,159.000000,165.000000,171.000000,177.000000,183.000000,189.000000,195.000000,201.000000,207.000000,213.000000,219.000000,225.000000,231.000000,237.000000,243.000000,249.000000,255.000000,261.000000,267.000000,273.000000,279.000000,284.000000,290.000000,296.000000,302.000000,308.000000,314.000000,320.000000,325.000000,331.000000,337.000000,343.000000,348.000000,354.000000,360.000000,366.000000,371.000000,377.000000,383.000000,388.000000,394.000000,400.000000,405.000000,411.000000,416.000000,422.000000,428.000000,433.000000,439.000000,444.000000,450.000000,455.000000,461.000000,466.000000,471.000000,477.000000,482.000000,488.000000,493.000000,498.000000,504.000000,509.000000,514.000000,519.000000,525.000000,530.000000,535.000000,540.000000,545.000000,550.000000,556.000000,561.000000,566.000000,571.000000,576.000000,581.000000,586.000000,591.000000,596.000000,601.000000,606.000000,610.000000,615.000000,620.000000,625.000000,630.000000,634.000000,639.000000,644.000000,649.000000,653.000000,658.000000,662.000000,667.000000,672.000000,676.000000,681.000000,685.000000,690.000000,694.000000,698.000000,703.000000,707.000000,711.000000,716.000000,720.000000,724.000000,728.000000,733.000000,737.000000,741.000000,745.000000,749.000000,753.000000,757.000000,761.000000,765.000000,769.000000,773.000000,777.000000,781.000000,785.000000,788.000000,792.000000,796.000000,800.000000,803.000000,807.000000,810.000000,814.000000,818.000000,821.000000,825.000000,828.000000,831.000000,835.000000,838.000000,842.000000,845.000000,848.000000,851.000000,855.000000,858.000000,861.000000,864.000000,867.000000,870.000000,873.000000,876.000000,879.000000,882.000000,885.000000,888.000000,890.000000,893.000000,896.000000,899.000000,901.000000,904.000000,907.000000,909.000000,912.000000,914.000000,917.000000,919.000000,922.000000,924.000000,926.000000,929.000000,931.000000,933.000000,935.000000,937.000000,939.000000,942.000000,944.000000,946.000000,948.000000,950.000000,951.000000,953.000000,955.000000,957.000000,959.000000,960.000000,962.000000,964.000000,965.000000,967.000000,969.000000,970.000000,972.000000,973.000000,974.000000,976.000000,977.000000,978.000000,980.000000,981.000000,982.000000,983.000000,984.000000,985.000000,986.000000,987.000000,988.000000,989.000000,990.000000,991.000000,992.000000,992.000000,993.000000,994.000000,995.000000,995.000000,996.000000,996.000000,997.000000,997.000000,998.000000,998.000000,998.000000,999.000000,999.000000,999.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,1000.000000,999.000000,999.000000,999.000000,998.000000,998.000000,998.000000,997.000000,997.000000,996.000000,996.000000,995.000000,995.000000,994.000000,993.000000,992.000000,992.000000,991.000000,990.000000,989.000000,988.000000,987.000000,986.000000,985.000000,984.000000,983.000000,982.000000,981.000000,980.000000,978.000000,977.000000,976.000000,974.000000,973.000000,972.000000,970.000000,969.000000,967.000000,965.000000,964.000000,962.000000,960.000000,959.000000,957.000000,955.000000,953.000000,951.000000,950.000000,948.000000,946.000000,944.000000,942.000000,939.000000,937.000000,935.000000,933.000000,931.000000,929.000000,926.000000,924.000000,922.000000,919.000000,917.000000,914.000000,912.000000,909.000000,907.000000,904.000000,901.000000,899.000000,896.000000,893.000000,890.000000,888.000000,885.000000,882.000000,879.000000,876.000000,873.000000,870.000000,867.000000,864.000000,861.000000,858.000000,855.000000,851.000000,848.000000,845.000000,842.000000,838.000000,835.000000,831.000000,828.000000,825.000000,821.000000,818.000000,814.000000,810.000000,807.000000,803.000000,800.000000,796.000000,792.000000,788.000000,785.000000,781.000000,777.000000,773.000000,769.000000,765.000000,761.000000,757.000000,753.000000,749.000000,745.000000,741.000000,737.000000,733.000000,728.000000,724.000000,720.000000,716.000000,711.000000,707.000000,703.000000,698.000000,694.000000,690.000000,685.000000,681.000000,676.000000,672.000000,667.000000,662.000000,658.000000,653.000000,649.000000,644.000000,639.000000,634.000000,630.000000,625.000000,620.000000,615.000000,610.000000,606.000000,601.000000,596.000000,591.000000,586.000000,581.000000,576.000000,571.000000,566.000000,561.000000,556.000000,550.000000,545.000000,540.000000,535.000000,530.000000,525.000000,519.000000,514.000000,509.000000,504.000000,498.000000,493.000000,488.000000,482.000000,477.000000,471.000000,466.000000,461.000000,455.000000,450.000000,444.000000,439.000000,433.000000,428.000000,422.000000,416.000000,411.000000,405.000000,400.000000,394.000000,388.000000,383.000000,377.000000,371.000000,366.000000,360.000000,354.000000,348.000000,343.000000,337.000000,331.000000,325.000000,320.000000,314.000000,308.000000,302.000000,296.000000,290.000000,284.000000,279.000000,273.000000,267.000000,261.000000,255.000000,249.000000,243.000000,237.000000,231.000000,225.000000,219.000000,213.000000,207.000000,201.000000,195.000000,189.000000,183.000000,177.000000,171.000000,165.000000,159.000000,153.000000,147.000000,141.000000,135.000000,128.000000,122.000000,116.000000,110.000000,104.000000,98.000000,92.000000,86.000000,80.000000,74.000000,67.000000,61.000000,55.000000,49.000000,43.000000,37.000000,31.000000,25.000000,18.000000,12.000000,6.000000,0.000000,-6.000000,-12.000000,-18.000000,-25.000000,-31.000000,-37.000000,-43.000000,-49.000000,-55.000000,-61.000000,-67.000000,-74.000000,-80.000000,-86.000000,-92.000000,-98.000000,-104.000000,-110.000000,-116.000000,-122.000000,-128.000000,-135.000000,-141.000000,-147.000000,-153.000000,-159.000000,-165.000000,-171.000000,-177.000000,-183.000000,-189.000000,-195.000000,-201.000000,-207.000000,-213.000000,-219.000000,-225.000000,-231.000000,-237.000000,-243.000000,-249.000000,-255.000000,-261.000000,-267.000000,-273.000000,-279.000000,-284.000000,-290.000000,-296.000000,-302.000000,-308.000000,-314.000000,-320.000000,-325.000000,-331.000000,-337.000000,-343.000000,-348.000000,-354.000000,-360.000000,-366.000000,-371.000000,-377.000000,-383.000000,-388.000000,-394.000000,-400.000000,-405.000000,-411.000000,-416.000000,-422.000000,-428.000000,-433.000000,-439.000000,-444.000000,-450.000000,-455.000000,-461.000000,-466.000000,-471.000000,-477.000000,-482.000000,-488.000000,-493.000000,-498.000000,-504.000000,-509.000000,-514.000000,-519.000000,-525.000000,-530.000000,-535.000000,-540.000000,-545.000000,-550.000000,-556.000000,-561.000000,-566.000000,-571.000000,-576.000000,-581.000000,-586.000000,-591.000000,-596.000000,-601.000000,-606.000000,-610.000000,-615.000000,-620.000000,-625.000000,-630.000000,-634.000000,-639.000000,-644.000000,-649.000000,-653.000000,-658.000000,-662.000000,-667.000000,-672.000000,-676.000000,-681.000000,-685.000000,-690.000000,-694.000000,-698.000000,-703.000000,-707.000000,-711.000000,-716.000000,-720.000000,-724.000000,-728.000000,-733.000000,-737.000000,-741.000000,-745.000000,-749.000000,-753.000000,-757.000000,-761.000000,-765.000000,-769.000000,-773.000000,-777.000000,-781.000000,-785.000000,-788.000000,-792.000000,-796.000000,-800.000000,-803.000000,-807.000000,-810.000000,-814.000000,-818.000000,-821.000000,-825.000000,-828.000000,-831.000000,-835.000000,-838.000000,-842.000000,-845.000000,-848.000000,-851.000000,-855.000000,-858.000000,-861.000000,-864.000000,-867.000000,-870.000000,-873.000000,-876.000000,-879.000000,-882.000000,-885.000000,-888.000000,-890.000000,-893.000000,-896.000000,-899.000000,-901.000000,-904.000000,-907.000000,-909.000000,-912.000000,-914.000000,-917.000000,-919.000000,-922.000000,-924.000000,-926.000000,-929.000000,-931.000000,-933.000000,-935.000000,-937.000000,-939.000000,-942.000000,-944.000000,-946.000000,-948.000000,-950.000000,-951.000000,-953.000000,-955.000000,-957.000000,-959.000000,-960.000000,-962.000000,-964.000000,-965.000000,-967.000000,-969.000000,-970.000000,-972.000000,-973.000000,-974.000000,-976.000000,-977.000000,-978.000000,-980.000000,-981.000000,-982.000000,-983.000000,-984.000000,-985.000000,-986.000000,-987.000000,-988.000000,-989.000000,-990.000000,-991.000000,-992.000000,-992.000000,-993.000000,-994.000000,-995.000000,-995.000000,-996.000000,-996.000000,-997.000000,-997.000000,-998.000000,-998.000000,-998.000000,-999.000000,-999.000000,-999.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-1000.000000,-999.000000,-999.000000,-999.000000,-998.000000,-998.000000,-998.000000,-997.000000,-997.000000,-996.000000,-996.000000,-995.000000,-995.000000,-994.000000,-993.000000,-992.000000,-992.000000,-991.000000,-990.000000,-989.000000,-988.000000,-987.000000,-986.000000,-985.000000,-984.000000,-983.000000,-982.000000,-981.000000,-980.000000,-978.000000,-977.000000,-976.000000,-974.000000,-973.000000,-972.000000,-970.000000,-969.000000,-967.000000,-965.000000,-964.000000,-962.000000,-960.000000,-959.000000,-957.000000,-955.000000,-953.000000,-951.000000,-950.000000,-948.000000,-946.000000,-944.000000,-942.000000,-939.000000,-937.000000,-935.000000,-933.000000,-931.000000,-929.000000,-926.000000,-924.000000,-922.000000,-919.000000,-917.000000,-914.000000,-912.000000,-909.000000,-907.000000,-904.000000,-901.000000,-899.000000,-896.000000,-893.000000,-890.000000,-888.000000,-885.000000,-882.000000,-879.000000,-876.000000,-873.000000,-870.000000,-867.000000,-864.000000,-861.000000,-858.000000,-855.000000,-851.000000,-848.000000,-845.000000,-842.000000,-838.000000,-835.000000,-831.000000,-828.000000,-825.000000,-821.000000,-818.000000,-814.000000,-810.000000,-807.000000,-803.000000,-800.000000,-796.000000,-792.000000,-788.000000,-785.000000,-781.000000,-777.000000,-773.000000,-769.000000,-765.000000,-761.000000,-757.000000,-753.000000,-749.000000,-745.000000,-741.000000,-737.000000,-733.000000,-728.000000,-724.000000,-720.000000,-716.000000,-711.000000,-707.000000,-703.000000,-698.000000,-694.000000,-690.000000,-685.000000,-681.000000,-676.000000,-672.000000,-667.000000,-662.000000,-658.000000,-653.000000,-649.000000,-644.000000,-639.000000,-634.000000,-630.000000,-625.000000,-620.000000,-615.000000,-610.000000,-606.000000,-601.000000,-596.000000,-591.000000,-586.000000,-581.000000,-576.000000,-571.000000,-566.000000,-561.000000,-556.000000,-550.000000,-545.000000,-540.000000,-535.000000,-530.000000,-525.000000,-519.000000,-514.000000,-509.000000,-504.000000,-498.000000,-493.000000,-488.000000,-482.000000,-477.000000,-471.000000,-466.000000,-461.000000,-455.000000,-450.000000,-444.000000,-439.000000,-433.000000,-428.000000,-422.000000,-416.000000,-411.000000,-405.000000,-400.000000,-394.000000,-388.000000,-383.000000,-377.000000,-371.000000,-366.000000,-360.000000,-354.000000,-348.000000,-343.000000,-337.000000,-331.000000,-325.000000,-320.000000,-314.000000,-308.000000,-302.000000,-296.000000,-290.000000,-284.000000,-279.000000,-273.000000,-267.000000,-261.000000,-255.000000,-249.000000,-243.000000,-237.000000,-231.000000,-225.000000,-219.000000,-213.000000,-207.000000,-201.000000,-195.000000,-189.000000,-183.000000,-177.000000,-171.000000,-165.000000,-159.000000,-153.000000,-147.000000,-141.000000,-135.000000,-128.000000,-122.000000,-116.000000,-110.000000,-104.000000,-98.000000,-92.000000,-86.000000,-80.000000,-74.000000,-67.000000,-61.000000,-55.000000,-49.000000,-43.000000,-37.000000,-31.000000,-25.000000,-18.000000,-12.000000,-6.000000};

int rawdata_to_angle(int rawdata)
{
return((int)(data2angle*rawdata));
}

/*
 * INPUTS:
 * theta: Raw angle value 0-1024
 * Ia,Ib,Ic- Phase Currents mA
 *
 * OUTPUTS:
 * Iq,Id: DQ currents mA
 */
void parkclark(int Ia,int Ib,int Ic,int theta,int *Iq,int *Id )
{
//	float part1,part2,part3;
//	if(Ia>10000||Ia<-10000){
//		part1=0;
//	}
//	part1=-sin_lut(theta)*Ia;
//	part2=-sin_lut(theta+240)*Ib;
//	part3=-sin_lut(theta+120)*Ic;
	*Iq = (pc_coff* ((0 - sin_lut(theta) * Ia - sin_lut(theta + 240) * Ib - sin_lut(theta + 120) * Ic)) / 1000) / 1000;
	*Id = (pc_coff* ((cos_lut(theta) * Ia + cos_lut(theta + 240) * Ib + cos_lut(theta + 120) * Ic)) / 1000) / 1000;
}

/*
 * INPUTS:
 * theta: Raw angle value 0-1024
 * Vq,Vd: Vq,Vd voltage mV
 *
 * OUTPUTS:
 * Va,Vb,Vc- OUTPUT VOLTAGE mV
 */
void inv_parkclark(int *Va, int *Vb, int *Vc, int theta, int Vq, int Vd )
{
	*Va = (int)(pc_coff * ((cos_lut(theta) * Vd - sin_lut(theta) * Vq)) / 1000) / 1000;
	*Vb = (int)(pc_coff * ((cos_lut(theta + 683) * Vd - sin_lut(theta + 683) *Vq)) / 1000) / 1000;
	*Vc = (int)(pc_coff * ((cos_lut(theta + 341) * Vd - sin_lut(theta + 341) *Vq)) / 1000) / 1000;
}

int sin_lut(int angle){
	return(sin_lut_table[angle % 1024]);
}

int cos_lut(int angle){
	return(sin_lut_table[(angle + 256) % 1024]);
}

int find_min_voltage(int32_t Va, int32_t Vb, int32_t Vc){
	int32_t ret_val = Va;
	if(ret_val > Vb){
		ret_val = Vb;
	}
	if(ret_val > Vc){
		ret_val = Vc;
	}
	return(ret_val);
}

